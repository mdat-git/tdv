flowchart LR
  %% =========================
  %% Styles
  %% =========================
  classDef bronze fill:#b87333,stroke:#5a3318,color:#fff,stroke-width:1px;
  classDef silver fill:#c0c0c0,stroke:#555,color:#111,stroke-width:1px;
  classDef gold fill:#d4af37,stroke:#6b5b1a,color:#111,stroke-width:1px;
  classDef ext fill:#1f6feb,stroke:#0b2f5b,color:#fff,stroke-width:1px;
  classDef etl fill:#111827,stroke:#374151,color:#fff,stroke-width:1px;

  %% =========================
  %% External inputs
  %% =========================
  RELCSV["Vendor Release CSV Upload<br>(Streamlit)<br>(full refresh per vendor)"]:::ext
  AZ["Azure Surveys Source"]:::ext
  GCPIMG["GCP Images Metadata Source"]:::ext
  DELIV["Deliveries Source"]:::ext
  INV["Invoice Lines Source<br>(includes scope_id + floc_id)"]:::ext
  VSP["Vendor SharePoint Site"]:::ext
  PBI["Power BI Dashboard"]:::ext

  %% =========================
  %% ETLs
  %% =========================
  ETL1["ETL-001: Release Intake + Delta Detection<br>(Streamlit-triggered)"]:::etl
  ETL2["ETL-002: Azure Survey Evidence"]:::etl
  ETL3["ETL-003: GCP Images Evidence"]:::etl
  ETL4["ETL-004: Deliveries Evidence"]:::etl
  ETL5["ETL-005: Invoice Lines"]:::etl
  ETL6["ETL-006: Eligibility Snapshot Publisher<br>(Official as-of snapshot)"]:::etl
  ETL7["ETL-007 (Optional): Vendor SharePoint Export Publisher"]:::etl

  %% =========================
  %% Bronze tables
  %% =========================
  B1["BRONZE.raw_scope_release_upload"]:::bronze
  B2["BRONZE.raw_scope_release_row"]:::bronze
  B3["BRONZE.raw_azure_survey"]:::bronze
  B4["BRONZE.raw_gcp_image_metadata"]:::bronze
  B5["BRONZE.raw_gcp_delivery"]:::bronze
  B6["BRONZE.raw_ap_invoice_line"]:::bronze

  %% =========================
  %% Silver tables
  %% =========================
  S1["SILVER.scope_release_header<br>(vendor_id x release_id)"]:::silver
  S2["SILVER.scope_release_line<br>(vendor_id x release_id x scope_id x floc_id)"]:::silver

  S3["SILVER.scope_assignment_history<br>(effective-dated)<br>(derived from successive releases)"]:::silver

  S4["SILVER.evidence_azure_survey_by_scope_package_floc"]:::silver
  S5["SILVER.evidence_gcp_images_by_scope_package_floc"]:::silver
  S6["SILVER.evidence_gcp_deliveries_by_scope_package_floc"]:::silver

  S7["SILVER.invoice_line_fact<br>(invoice_id x scope_package_id x floc_id)"]:::silver

  %% =========================
  %% Gold tables/views
  %% =========================
  G1["GOLD.scope_assignment_current"]:::gold
  G2["GOLD.invoice_eligibility_snapshot_line<br>(snapshot_id x package x floc)"]:::gold
  G3["GOLD.invoice_eligibility_snapshot_scope_package_summary<br>(snapshot_id x package)"]:::gold

  GV1["GOLD.vw_vendor_invoice_ledger_current<br>(latest snapshot)"]:::gold
  GV2["GOLD.vw_vendor_approved_to_invoice"]:::gold
  GV3["GOLD.vw_vendor_blocked_items"]:::gold
  GV4["GOLD.vw_vendor_invoiced_paid_history"]:::gold

  %% =========================
  %% ETL 1 flow (Release Intake)
  %% =========================
  RELCSV --> ETL1
  ETL1 --> B1
  ETL1 --> B2

  B1 --> S1
  B2 --> S2

  %% Delta detection / history derivation
  S2 --> S3
  S3 --> G1

  %% =========================
  %% ETL 2 flow (Azure surveys)
  %% =========================
  AZ --> ETL2
  ETL2 --> B3
  B3 --> S4

  %% =========================
  %% ETL 3 flow (GCP images)
  %% =========================
  GCPIMG --> ETL3
  ETL3 --> B4
  B4 --> S5

  %% =========================
  %% ETL 4 flow (Deliveries)
  %% =========================
  DELIV --> ETL4
  ETL4 --> B5
  B5 --> S6

  %% =========================
  %% ETL 5 flow (Invoice lines)
  %% =========================
  INV --> ETL5
  ETL5 --> B6
  B6 --> S7

  %% =========================
  %% ETL 6 flow (Eligibility snapshot)
  %% =========================
  G1 --> ETL6
  S4 --> ETL6
  S5 --> ETL6
  S6 --> ETL6
  S7 --> ETL6

  ETL6 --> G2
  ETL6 --> G3

  G2 --> GV1
  G2 --> GV2
  G2 --> GV3
  G2 --> GV4

  %% =========================
  %% Power BI consumption
  %% =========================
  GV1 --> PBI
  GV2 --> PBI
  GV3 --> PBI
  GV4 --> PBI

  %% =========================
  %% ETL 7 flow (Vendor export)
  %% =========================
  G2 --> ETL7
  G3 --> ETL7
  ETL7 --> VSP
